<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - LMS</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <div id="alerts"></div>

  <div class="container">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 1px solid var(--border);">
      <div>
        <h1 style="font-size: 2.25rem; font-weight: 800; margin-bottom: 0.5rem;">Dashboard</h1>
        <p style="color: var(--text-secondary);">Welcome back to your learning space</p>
      </div>
      <div id="user-info" style="text-align: right; background: var(--surface-alt); padding: 1.5rem; border-radius: 0.875rem; min-width: 200px;">
        <p id="user-name" style="margin: 0; font-weight: 700; font-size: 1.1rem; color: var(--text-primary);"></p>
        <p id="user-role" style="margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600;"></p>
      </div>
    </div>

    <div id="admin-section" style="display: none; margin-bottom: 4rem;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2 style="font-size: 1.5rem; font-weight: 700;">My Courses</h2>
        <button class="btn btn-primary" onclick="showCreateCourseModal()">+ New Course</button>
      </div>
      <div id="admin-courses" class="grid grid-2"></div>
    </div>

    <div id="student-section">
      <h2 style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1.5rem;">Enrolled Courses</h2>
      <div id="enrollments" class="grid grid-2" style="margin-bottom: 2rem;"></div>
    </div>
  </div>

  <!-- Create Course Modal -->
  <div id="course-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 999; display: flex; justify-content: center; align-items: center; padding: 2rem;">
    <div class="form-container" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <h2 class="form-title">Create New Course</h2>
      <form id="course-form">
        <div class="form-group">
          <label for="course-title">Course Title</label>
          <input type="text" id="course-title" name="title" placeholder="e.g., React Fundamentals" required />
        </div>
        <div class="form-group">
          <label for="course-description">Course Description</label>
          <textarea id="course-description" name="description" placeholder="Describe what students will learn in this course..."></textarea>
        </div>
        <div style="display: flex; gap: 1rem;">
          <button type="submit" class="btn btn-primary" style="flex: 1;">Create Course</button>
          <button type="button" class="btn btn-secondary" style="flex: 1;" onclick="hideCreateCourseModal()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <script type="module">
    import { auth, enrollments, courses } from '/js/api.js';
    import { renderNavigation, renderAlertContainer, showAlert, formatDate, getInitials } from '/js/utils.js';

    renderAlertContainer();
    renderNavigation();

    let currentUser = null;

    async function initDashboard() {
      try {
        currentUser = await auth.getCurrentUser();
        document.getElementById('user-name').textContent = currentUser.name;
        document.getElementById('user-role').textContent = currentUser.role === 'admin' ? 'üë®‚Äçüíº Administrator' : 'üë®‚Äçüéì Student';

        if (currentUser.role === 'admin') {
          document.getElementById('admin-section').style.display = 'block';
          document.getElementById('student-section').style.display = 'none';
          await loadAdminCourses();
        } else {
          await loadEnrollments();
        }
      } catch (error) {
        showAlert('Failed to load user information', 'error');
        window.location.href = '/login.html';
      }
    }

    async function loadAdminCourses() {
      try {
        const data = await courses.getAdminCourses();
        const container = document.getElementById('admin-courses');
        
        if (data.length === 0) {
          container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">üìö</div><p class="empty-state-title">No courses yet</p><p class="empty-state-description">Create your first course to get started</p></div>';
          return;
        }

        container.innerHTML = data.map(course => `
          <div class="card">
            <div class="card-header">
              <div style="flex: 1;">
                <h3 class="card-title">${course.title}</h3>
                <p class="card-subtitle">${course.description || 'No description'}</p>
              </div>
            </div>
            <div class="card-body">
              <p style="font-size: 0.85rem; color: var(--text-muted);">Created ${formatDate(course.created_at)}</p>
            </div>
            <div class="card-footer">
              <button class="btn btn-secondary" style="padding: 0.625rem 1rem;" onclick="editCourse(${course.id})">Edit</button>
              <button class="btn btn-danger" style="padding: 0.625rem 1rem;" onclick="deleteCourse(${course.id})">Delete</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        showAlert('Failed to load courses', 'error');
      }
    }

    async function loadEnrollments() {
      try {
        const data = await enrollments.getMyEnrollments();
        const container = document.getElementById('enrollments');
        
        if (data.length === 0) {
          container.innerHTML = '<div class="empty-state" style="grid-column: 1/-1;"><div class="empty-state-icon">üìö</div><p class="empty-state-title">No enrollments yet</p><p class="empty-state-description"><a href="/courses.html" style="color: var(--primary); font-weight: 600;">Browse available courses</a> to get started</p></div>';
          return;
        }

        container.innerHTML = data.map(enrollment => `
          <div class="card">
            <div class="card-header">
              <div style="flex: 1;">
                <h3 class="card-title">${enrollment.course_title}</h3>
                <p class="card-subtitle">${enrollment.course_description || 'No description'}</p>
              </div>
              <span class="badge ${enrollment.status === 'completed' ? 'badge-success' : 'badge-warning'}">
                ${enrollment.status === 'completed' ? '‚úì Completed' : '‚è≥ In Progress'}
              </span>
            </div>
            <div class="card-body">
              <div style="display: flex; gap: 2rem; font-size: 0.85rem; color: var(--text-muted);">
                <span>üìÖ Enrolled ${formatDate(enrollment.enrolled_at)}</span>
                ${enrollment.completed_at ? `<span>‚úì Completed ${formatDate(enrollment.completed_at)}</span>` : ''}
              </div>
            </div>
            <div class="card-footer">
              <button class="btn btn-danger" style="padding: 0.625rem 1rem;" onclick="unenroll(${enrollment.id})">Unenroll</button>
            </div>
          </div>
        `).join('');
      } catch (error) {
        showAlert('Failed to load enrollments', 'error');
      }
    }

    window.showCreateCourseModal = function() {
      document.getElementById('course-modal').style.display = 'flex';
    };

    window.hideCreateCourseModal = function() {
      document.getElementById('course-modal').style.display = 'none';
    };

    window.deleteCourse = async function(courseId) {
      if (confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        try {
          const result = await courses.delete(courseId);
          showAlert('Course deleted successfully', 'success');
          await loadAdminCourses();
        } catch (error) {
          showAlert('Failed to delete course', 'error');
        }
      }
    };

    window.unenroll = async function(enrollmentId) {
      if (confirm('Are you sure you want to unenroll from this course?')) {
        try {
          const result = await enrollments.unenroll(enrollmentId);
          showAlert('Unenrolled successfully', 'success');
          await loadEnrollments();
        } catch (error) {
          showAlert('Failed to unenroll', 'error');
        }
      }
    };

    document.getElementById('course-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const title = document.getElementById('course-title').value.trim();
      const description = document.getElementById('course-description').value.trim();

      if (!title) {
        showAlert('Please enter a course title', 'error');
        return;
      }

      try {
        const result = await courses.create(title, description);
        showAlert('‚úì Course created successfully', 'success');
        document.getElementById('course-form').reset();
        hideCreateCourseModal();
        await loadAdminCourses();
      } catch (error) {
        showAlert('Failed to create course', 'error');
      }
    });

    initDashboard();
  </script>
</body>
</html>
